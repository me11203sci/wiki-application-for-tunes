name: Pull Request Report Generation Workflow

on:
    pull_request:
      branches: [master]

jobs:
  prepare_environment:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}

    steps:
      - uses: actions/checkout@v4

      - name: Cache Miniconda Installation
        id: cache-miniconda
        uses: actions/cache@v4
        with:
          path: /root/miniconda3
          key: ${{ runner.os }}-miniconda-v0-${{ env.PYTHON_VERSION }} # Change version number to invalidate cache, forcing update.
          restore-keys: ${{ runner.os }}-miniconda-

      - name: Setup Miniconda
        if: steps.cache-miniconda.outputs.cache-hit != 'true'
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: 3.13

      - name: Cache Conda Environment
        id: cache-waft-dev
        uses: actions/cache@v4
        with:
          path: /root/miniconda3/envs/waft-dev
          key: ${{ runner.os }}-conda-${{ hashFiles('environment.yml') }}
          restore-keys: ${{ runner.os }}-conda-

      - name: Setup Conda Environment
        if: steps.cache-waft-dev.outputs.cache-hit != 'true'
        run: |
          source /root/miniconda3/bin/activate
          conda env create -f environment.yml

  analysis:
    runs-on: ubuntu-latest
    needs: prepare_environment
    defaults:
      run:
        shell: bash -l {0}

    steps:
      - uses: actions/checkout@v4

      - name: Restore Miniconda Installation
        id: cache-miniconda
        uses: actions/cache@v4
        with:
          path: /root/miniconda3
          key: ${{ runner.os }}-miniconda-v0-${{ env.PYTHON_VERSION }} # Ensure version number is the same as above.
          restore-keys: ${{ runner.os }}-miniconda-

      - name: Restore Conda Environment
        id: cache-conda
        uses: actions/cache@v4
        with:
          path: /root/miniconda3/envs/waft-dev
          key: ${{ runner.os }}-conda-${{ hashFiles('environment.yml') }}
          restore-keys: ${{ runner.os }}-conda-

      - name: Run Black Formatter
        run: |
          source /root/miniconda3/bin/activate waft-dev
          echo "====[BLACK]========================================================================================================" >> analysis.log
          black --check src/ >> analysis.log 2>&1
        continue-on-error: true

      - name: Run isort Formatter
        run: |
          echo "====[ISORT]========================================================================================================" >> analysis.log
          source /root/miniconda3/bin/activate waft-dev
          isort src/ --check-only --verbose >> analysis.log 2>&1
        continue-on-error: true

      - name: Run flake8 for Style Compliance
        run: |
          echo "====[FLAKE8]=======================================================================================================" >> analysis.log
          source /root/miniconda3/bin/activate waft-dev
          flake8 --verbose --docstring-convention=numpy src/ >> analysis.log 2>&1
        continue-on-error: true

      - name: Run mypy for Type Checking
        run: |
          echo "====[MYPY]=========================================================================================================" >> analysis.log
          source /root/miniconda3/bin/activate waft-dev
          mypy src/ >> analysis.log 2>&1
        continue-on-error: true

      - name: Run pytest
        run: |
          echo "====[PYTEST]=======================================================================================================" >> analysis.log
          source /root/miniconda3/bin/activate waft-dev
          pytest >> analysis.log 2>&1
        continue-on-error: true

      - name: Run Coverage.py
        run: |
          echo "====[COVERAGE.py]=================================================================================================" >> analysis.log
          source /root/miniconda3/bin/activate waft-dev
          coverage run >> analysis.log 2>&1
          coverage report >> analysis.log 2>&1
        continue-on-error: true

      - name: Run interrogate
        run: |
          echo "====[INTERROGATE]=================================================================================================" >> analysis.log
          source /root/miniconda3/bin/activate waft-dev
          interrogate >> analysis.log 2>&1
        continue-on-error: true

      - name: Output Log to Terminal
        run: |
          cat analysis.log

      - name: Upload Analysis Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report
          path: analysis.log

  comment_on_pr:
    runs-on: ubuntu-latest
    needs: [prepare_environment, analysis]

    steps:
      - uses: actions/checkout@v4

      - name: Comment on Pull Request
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = process.env.GITHUB_RUN_ID;
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              core.warning("No pull request context found; skipping comment.");
              return;
            }
            const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;
            const commentBody = `A new code analysis report has been generated for this Pull Request: **[View the full report artifact](${artifactUrl})**`;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: commentBody
            });
