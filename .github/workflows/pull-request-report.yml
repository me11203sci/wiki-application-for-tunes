name: Pull Request Report Generation Workflow

on:
    pull_request:
      branches: [master]

jobs:
  analysis:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Conda Environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          environment-file: environment.yml
          activate-environment: waft-dev

      - name: Run Black Formatter
        run: |
          echo "====[BLACK]========================================================================================================" >> analysis.log
          black --check src/ >> analysis.log 2>&1
        continue-on-error: true

      - name: Run isort Formatter
        run: |
          echo "====[ISORT]========================================================================================================" >> analysis.log
          isort src/ --check-only --verbose >> analysis.log 2>&1
        continue-on-error: true

      - name: Run flake8 for Style Compliance
        run: |
          echo "====[FLAKE8]=======================================================================================================" >> analysis.log
          flake8 --verbose --docstring-convention=numpy src/ >> analysis.log 2>&1
        continue-on-error: true

      - name: Run mypy for Type Checking
        run: |
          echo "====[MYPY]=========================================================================================================" >> analysis.log
          mypy src/ >> analysis.log 2>&1
        continue-on-error: true

      - name: Run pytest
        run: |
          echo "====[PYTEST]=======================================================================================================" >> analysis.log
          pytest >> analysis.log 2>&1
        continue-on-error: true

      - name: Run Coverage.py
        run: |
          echo "====[COVERAGE.py]=================================================================================================" >> analysis.log
          coverage run >> analysis.log 2>&1
          coverage report >> analysis.log 2>&1
        continue-on-error: true

      - name: Run interrogate
        run: |
          echo "====[INTERROGATE]=================================================================================================" >> analysis.log
          interrogate >> analysis.log 2>&1
        continue-on-error: true

      - name: Output Log to Terminal
        run: |
          cat analysis.log

      - name: Upload Analysis Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report
          path: analysis.log

  comment_on_pr:
    runs-on: ubuntu-latest
    needs: analysis

    steps:
      - uses: actions/checkout@v4

      - name: Comment on Pull Request
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = process.env.GITHUB_RUN_ID;
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              core.warning("No pull request context found; skipping comment.");
              return;
            }
            const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;
            const commentBody = `A new code analysis report has been generated for this Pull Request: **[View the full report artifact](${artifactUrl})**`;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: commentBody
            });
